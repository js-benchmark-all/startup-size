var e=(e,t,n)=>{return(r,i)=>{let a=-1;return o(0);async function o(s){if(s<=a)throw new Error(`next() called multiple times`);a=s;let c;let l=false;let u;if(e[s]){u=e[s][0][0];r.req.routeIndex=s}else u=s===e.length&&i||void 0;if(u)try{c=await u(r,()=>o(s+1))}catch(e){if(e instanceof Error&&t){r.error=e;c=await t(e,r);l=true}else throw e}else if(r.finalized===false&&n)c=await n(r);if(c&&(r.finalized===false||l))r.res=c;return r}}};var t=Symbol();var n=async(e,t=Object.create(null))=>{const{all:n=false,dot:i=false}=t;const a=e instanceof v?e.raw.headers:e.headers;const o=a.get(`Content-Type`);if(o?.startsWith(`multipart/form-data`)||o?.startsWith(`application/x-www-form-urlencoded`))return r(e,{all:n,dot:i});return{}};async function r(e,t){const n=await e.formData();if(n)return i(n,t);return{}}function i(e,t){const n=Object.create(null);e.forEach((e,r)=>{const i=t.all||r.endsWith(`[]`);if(!i)n[r]=e;else a(n,r,e)});if(t.dot)Object.entries(n).forEach(([e,t])=>{const r=e.includes(`.`);if(r){o(n,e,t);delete n[e]}});return n}var a=(e,t,n)=>{if(e[t]!==void 0)if(Array.isArray(e[t]))e[t].push(n);else e[t]=[e[t],n];else if(!t.endsWith(`[]`))e[t]=n;else e[t]=[n]};var o=(e,t,n)=>{let r=e;const i=t.split(`.`);i.forEach((e,t)=>{if(t===i.length-1)r[e]=n;else{if(!r[e]||typeof r[e]!==`object`||Array.isArray(r[e])||r[e]instanceof File)r[e]=Object.create(null);r=r[e]}})};var s=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,e=>{try{return t(e)}catch{return e}})}};var c=e=>s(e,decodeURI);var l=e=>{const t=e.url;const n=t.indexOf(`/`,t.charCodeAt(9)===58?13:8);let r=n;for(;r<t.length;r++){const e=t.charCodeAt(r);if(e===37){const e=t.indexOf(`?`,r);const i=t.slice(n,e===-1?void 0:e);return c(i.includes(`%25`)?i.replace(/%25/g,`%2525`):i)}else if(e===63)break}return t.slice(n,r)};var u=e=>{const t=l(e);return t.length>1&&t.at(-1)===`/`?t.slice(0,-1):t};var d=(e,t,...n)=>{if(n.length)t=d(t,...n);return`${e?.[0]===`/`?``:`/`}${e}${t===`/`?``:`${e?.at(-1)===`/`?``:`/`}${t?.[0]===`/`?t.slice(1):t}`}`};var f=e=>{if(!/[%+]/.test(e))return e;if(e.indexOf(`+`)!==-1)e=e.replace(/\+/g,` `);return e.indexOf(`%`)!==-1?s(e,g):e};var p=(e,t,n)=>{let r;if(!n&&t&&!/[%+]/.test(t)){let n=e.indexOf(`?${t}`,8);if(n===-1)n=e.indexOf(`&${t}`,8);while(n!==-1){const r=e.charCodeAt(n+t.length+1);if(r===61){const r=n+t.length+2;const i=e.indexOf(`&`,r);return f(e.slice(r,i===-1?void 0:i))}else if(r==38||isNaN(r))return``;n=e.indexOf(`&${t}`,n+1)}r=/[%+]/.test(e);if(!r)return void 0}const i={};r??=/[%+]/.test(e);let a=e.indexOf(`?`,8);while(a!==-1){const t=e.indexOf(`&`,a+1);let o=e.indexOf(`=`,a);if(o>t&&t!==-1)o=-1;let s=e.slice(a+1,o===-1?t===-1?void 0:t:o);if(r)s=f(s);a=t;if(s===``)continue;let c;if(o===-1)c=``;else{c=e.slice(o+1,t===-1?void 0:t);if(r)c=f(c)}if(n){if(!(i[s]&&Array.isArray(i[s])))i[s]=[];i[s].push(c)}else i[s]??=c}return t?i[t]:i};var m=p;var h=(e,t)=>{return p(e,t,true)};var g=decodeURIComponent;var _=e=>s(e,g);var v=class{raw;#validatedData;#matchResult;routeIndex=0;path;bodyCache={};constructor(e,t=`/`,n=[[]]){this.raw=e;this.path=t;this.#matchResult=n;this.#validatedData={}}param(e){return e?this.#getDecodedParam(e):this.#getAllDecodedParams()}#getDecodedParam(e){const t=this.#matchResult[0][this.routeIndex][1][e];const n=this.#getParamValue(t);return n?/\%/.test(n)?_(n):n:void 0}#getAllDecodedParams(){const e={};const t=Object.keys(this.#matchResult[0][this.routeIndex][1]);for(const n of t){const t=this.#getParamValue(this.#matchResult[0][this.routeIndex][1][n]);if(t&&typeof t===`string`)e[n]=/\%/.test(t)?_(t):t}return e}#getParamValue(e){return this.#matchResult[1]?this.#matchResult[1][e]:e}query(e){return m(this.url,e)}queries(e){return h(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;const t={};this.raw.headers.forEach((e,n)=>{t[n]=e});return t}async parseBody(e){return this.bodyCache.parsedBody??=await n(this,e)}#cachedBody=e=>{const{bodyCache:t,raw:n}=this;const r=t[e];if(r)return r;const i=Object.keys(t)[0];if(i)return t[i].then(t=>{if(i===`json`)t=JSON.stringify(t);return new Response(t)[e]()});return t[e]=n[e]()};json(){return this.#cachedBody(`text`).then(e=>JSON.parse(e))}text(){return this.#cachedBody(`text`)}arrayBuffer(){return this.#cachedBody(`arrayBuffer`)}blob(){return this.#cachedBody(`blob`)}formData(){return this.#cachedBody(`formData`)}addValidatedData(e,t){this.#validatedData[e]=t}valid(e){return this.#validatedData[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[t](){return this.#matchResult}get matchedRoutes(){return this.#matchResult[0].map(([[,e]])=>e)}get routePath(){return this.#matchResult[0].map(([[,e]])=>e)[this.routeIndex].path}};var y={Stringify:1,BeforeStream:2,Stream:3};var b=(e,t)=>{const n=new String(e);n.isEscaped=true;n.callbacks=t;return n};var x=async(e,t,n,r,i)=>{if(typeof e===`object`&&!(e instanceof String)){if(!(e instanceof Promise))e=e.toString();if(e instanceof Promise)e=await e}const a=e.callbacks;if(!a?.length)return Promise.resolve(e);if(i)i[0]+=e;else i=[e];const o=Promise.all(a.map(e=>e({phase:t,buffer:i,context:r}))).then(e=>Promise.all(e.filter(Boolean).map(e=>x(e,t,false,r,i))).then(()=>i[0]));if(n)return b(await o,a);else return o};var S=`text/plain; charset=UTF-8`;var C=(e,t)=>{return{"Content-Type":e,...t}};var w=class{#rawRequest;#req;env={};#var;finalized=false;error;#status;#executionCtx;#res;#layout;#renderer;#notFoundHandler;#preparedHeaders;#matchResult;#path;constructor(e,t){this.#rawRequest=e;if(t){this.#executionCtx=t.executionCtx;this.env=t.env;this.#notFoundHandler=t.notFoundHandler;this.#path=t.path;this.#matchResult=t.matchResult}}get req(){this.#req??=new v(this.#rawRequest,this.#path,this.#matchResult);return this.#req}get event(){if(this.#executionCtx&&`respondWith`in this.#executionCtx)return this.#executionCtx;else throw Error(`This context has no FetchEvent`)}get executionCtx(){if(this.#executionCtx)return this.#executionCtx;else throw Error(`This context has no ExecutionContext`)}get res(){return this.#res||=new Response(null,{headers:this.#preparedHeaders??=new Headers})}set res(e){if(this.#res&&e){e=new Response(e.body,e);for(const[t,n]of this.#res.headers.entries()){if(t===`content-type`)continue;if(t===`set-cookie`){const t=this.#res.headers.getSetCookie();e.headers.delete(`set-cookie`);for(const n of t)e.headers.append(`set-cookie`,n)}else e.headers.set(t,n)}}this.#res=e;this.finalized=true}render=(...e)=>{this.#renderer??=e=>this.html(e);return this.#renderer(...e)};setLayout=e=>this.#layout=e;getLayout=()=>this.#layout;setRenderer=e=>{this.#renderer=e};header=(e,t,n)=>{if(this.finalized)this.#res=new Response(this.#res.body,this.#res);const r=this.#res?this.#res.headers:this.#preparedHeaders??=new Headers;if(t===void 0)r.delete(e);else if(n?.append)r.append(e,t);else r.set(e,t)};status=e=>{this.#status=e};set=(e,t)=>{this.#var??=new Map;this.#var.set(e,t)};get=e=>{return this.#var?this.#var.get(e):void 0};get var(){if(!this.#var)return{};return Object.fromEntries(this.#var)}#newResponse(e,t,n){const r=this.#res?new Headers(this.#res.headers):this.#preparedHeaders??new Headers;if(typeof t===`object`&&`headers`in t){const e=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(const[t,n]of e)if(t.toLowerCase()===`set-cookie`)r.append(t,n);else r.set(t,n)}if(n)for(const[e,t]of Object.entries(n))if(typeof t===`string`)r.set(e,t);else{r.delete(e);for(const n of t)r.append(e,n)}const i=typeof t===`number`?t:t?.status??this.#status;return new Response(e,{status:i,headers:r})}newResponse=(...e)=>this.#newResponse(...e);body=(e,t,n)=>this.#newResponse(e,t,n);text=(e,t,n)=>{return!this.#preparedHeaders&&!this.#status&&!t&&!n&&!this.finalized?new Response(e):this.#newResponse(e,t,C(S,n))};json=(e,t,n)=>{return this.#newResponse(JSON.stringify(e),t,C(`application/json`,n))};html=(e,t,n)=>{const r=e=>this.#newResponse(e,t,C(`text/html; charset=UTF-8`,n));return typeof e===`object`?x(e,y.Stringify,false,{}).then(r):r(e)};redirect=(e,t)=>{this.header(`Location`,String(e));return this.newResponse(null,t??302)};notFound=()=>{this.#notFoundHandler??=()=>new Response;return this.#notFoundHandler(this)}};var T=`ALL`;var E=`all`;var D=[`get`,`post`,`put`,`delete`,`options`,`patch`];var O=class extends Error{};var k=`__COMPOSED_HANDLER`;var A=e=>{return e.text(`404 Not Found`,404)};var j=(e,t)=>{if(`getResponse`in e){const n=e.getResponse();return t.newResponse(n.body,n)}console.error(e);return t.text(`Internal Server Error`,500)};var M=class{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath=`/`;#path=`/`;routes=[];constructor(e={}){const t=[...D,E];t.forEach(e=>{this[e]=(t,...n)=>{if(typeof t===`string`)this.#path=t;else this.#addRoute(e,this.#path,t);n.forEach(t=>{this.#addRoute(e,this.#path,t)});return this}});this.on=(e,t,...n)=>{for(const r of[t].flat()){this.#path=r;for(const t of[e].flat())n.map(e=>{this.#addRoute(t.toUpperCase(),this.#path,e)})}return this};this.use=(e,...t)=>{if(typeof e===`string`)this.#path=e;else{this.#path=`*`;t.unshift(e)}t.forEach(e=>{this.#addRoute(T,this.#path,e)});return this};const{strict:n,...r}=e;Object.assign(this,r);this.getPath=n??true?e.getPath??l:u}#clone(){const e=new M({router:this.router,getPath:this.getPath});e.errorHandler=this.errorHandler;e.#notFoundHandler=this.#notFoundHandler;e.routes=this.routes;return e}#notFoundHandler=A;errorHandler=j;route(t,n){const r=this.basePath(t);n.routes.map(t=>{let i;if(n.errorHandler===j)i=t.handler;else{i=async(r,i)=>(await e([],n.errorHandler)(r,()=>t.handler(r,i))).res;i[k]=t.handler}r.#addRoute(t.method,t.path,i)});return this}basePath(e){const t=this.#clone();t._basePath=d(this._basePath,e);return t}onError=e=>{this.errorHandler=e;return this};notFound=e=>{this.#notFoundHandler=e;return this};mount(e,t,n){let r;let i;if(n)if(typeof n===`function`)i=n;else{i=n.optionHandler;if(n.replaceRequest===false)r=e=>e;else r=n.replaceRequest}const a=i?e=>{const t=i(e);return Array.isArray(t)?t:[t]}:e=>{let t=void 0;try{t=e.executionCtx}catch{}return[e.env,t]};r||=(()=>{const t=d(this._basePath,e);const n=t===`/`?0:t.length;return e=>{const t=new URL(e.url);t.pathname=t.pathname.slice(n)||`/`;return new Request(t,e)}})();const o=async(e,n)=>{const i=await t(r(e.req.raw),...a(e));if(i)return i;await n()};this.#addRoute(T,d(e,`*`),o);return this}#addRoute(e,t,n){e=e.toUpperCase();t=d(this._basePath,t);const r={basePath:this._basePath,path:t,method:e,handler:n};this.router.add(e,t,[n,r]);this.routes.push(r)}#handleError(e,t){if(e instanceof Error)return this.errorHandler(e,t);throw e}#dispatch(t,n,r,i){if(i===`HEAD`)return(async()=>new Response(null,await this.#dispatch(t,n,r,`GET`)))();const a=this.getPath(t,{env:r});const o=this.router.match(i,a);const s=new w(t,{path:a,matchResult:o,env:r,executionCtx:n,notFoundHandler:this.#notFoundHandler});if(o[0].length===1){let e;try{e=o[0][0][0][0](s,async()=>{s.res=await this.#notFoundHandler(s)})}catch(e){return this.#handleError(e,s)}return e instanceof Promise?e.then(e=>e||(s.finalized?s.res:this.#notFoundHandler(s))).catch(e=>this.#handleError(e,s)):e??this.#notFoundHandler(s)}const c=e(o[0],this.errorHandler,this.#notFoundHandler);return(async()=>{try{const e=await c(s);if(!e.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return e.res}catch(e){return this.#handleError(e,s)}})()}fetch=(e,...t)=>{return this.#dispatch(e,t[1],t[0],e.method)};request=(e,t,n,r)=>{if(e instanceof Request)return this.fetch(t?new Request(e,t):e,n,r);e=e.toString();return this.fetch(new Request(/^https?:\/\//.test(e)?e:`http://localhost${d(`/`,e)}`,t),n,r)};fire=()=>{addEventListener(`fetch`,e=>{e.respondWith(this.#dispatch(e.request,e,void 0,e.request.method))})}};var N=Object.create(null);var P=class{name=`PatternRouter`;#routes=[];add(e,t,n){const r=t.at(-1)===`*`;if(r)t=t.slice(0,-2);if(t.at(-1)===`?`){t=t.slice(0,-1);this.add(e,t.replace(/\/[^/]+$/,``),n)}const i=(t.match(/\/?(:\w+(?:{(?:(?:{[\d,]+})|[^}])+})?)|\/?[^\/\?]+/g)||[]).map(e=>{const t=e.match(/^\/:([^{]+)(?:{(.*)})?/);return t?`/(?<${t[1]}>${t[2]||`[^/]+`})`:e===`/*`?`/[^/]+`:e.replace(/[.\\+*[^\]$()]/g,`\\$&`)});try{this.#routes.push([new RegExp(`^${i.join(``)}${r?``:`/?$`}`),e,n])}catch{throw new O}}match(e,t){const n=[];for(let r=0,i=this.#routes.length;r<i;r++){const[i,a,o]=this.#routes[r];if(a===e||a===T){const e=i.exec(t);if(e)n.push([o,e.groups||N])}}return[n]}};var F=class extends M{constructor(e={}){super(e);this.router=new P}};new F({router:new P}).get(`/`,e=>e.body(`Hi`)).get(`/user/:id`,e=>e.body(e.req.param(`id`))).post(`/body`,async e=>e.json(await e.req.json())).fetch(new Request(`http://127.0.0.1`));